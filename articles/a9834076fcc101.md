---
title: "AWS Amplify で Next.js App Router を利用する"
emoji: "🚀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [aws,amplify,nextjs,approuter,typescript]
published: false
---

## はじめに

https://aws.amazon.com/jp/blogs/news/amplify-javascript-v6/

上記ブログでもあるように、 Amplify で Next.js App Router を利用することができるようになりました。
今回は Amplify で Next.js App Router を利用する方法に加え、Amplify Backend で Auth (Cognite) と API (GraphQL + DynamoDB) を追加し、簡易的な CRUD アプリケーションを作成します。

## 対象読者

- AWS Amplify で Next.js App Router を利用したい方
- AWS アカウントをお持ちの方
- AWS の基本的な知識をお持ちの方
- Next.js の基本的な知識をお持ちの方
- TypeScript の基本的な知識をお持ちの方

## 事前準備

https://docs.amplify.aws/nextjs/start/getting-started/installation/

上記の docs に沿って、事前準備を行います。
※ Node.js と Git がインストールされていることを前提とします。

### AWS アカウントの作成

AWS アカウントを持っていない方は、上記の docs から「Create AWS Account」のリンクをクリックして、AWS アカウントを作成します。
※ admin 権限を持った IAM ユーザーを作成し、その IAM ユーザーでログインすることをおすすめします。

### Amplify CLI のインストール

Amplify CLI をインストールします。

```bash
npm install -g @aws-amplify/cli
```

### Amplify CLI の初期化

Amplify CLI を初期化します。

```bash
amplify configure
```

上記コマンドを叩くと、ブラウザが開きますので、AWS アカウントでログインしてください。
ログイン後、以下のような画面が表示されるので、「Continue」をクリックしてください。

```bash
❯ amplify configure
Follow these steps to set up access to your AWS account:

Sign in to your AWS administrator account:
https://console.aws.amazon.com/
Press Enter to continue
```

次にターミナルで region を選択します。
※ 今回は ap-northeast-1 を選択します。

```bash
Specify the AWS Region
? region:  ap-northeast-1
```

次にブラウザで Amplify 用の IAM ユーザーを作成します。
詳細は [docs の `Enter a User name and select Next. You can name the user anything but we'll call it "amplify-dev".`](https://docs.amplify.aws/javascript/start/getting-started/installation/#configure-the-amplify-cli) から始まるを参照してください。

docs ではユーザを `amplify-dev` で、ポリシーを `AdministratorAccess-Amplify` で作成しています。

ユーザを作成したら、アクセストークンを発行します。
amplify-dev をクリックし、「セキュリティ認証情報」のタブをクリックし、「アクセストークン」のセクションからアクセスキーを発行します。

docs に沿って進めていくと、ターミナルに戻り、Enterを押すと、`Access key` と `Secret access key` を求められるので、コピペして入力します。

※ AWS Profile を求められるので、利用している端末で初めて設定するのであれば `default` 、もしすでに `default` が設定してある場合は `amplify-dev` など、わかりやすい名称が良いと思います。

```bash
Enter the access key of the newly created user:
? accessKeyId:  # YOUR_ACCESS_KEY_ID
? secretAccessKey:  # YOUR_SECRET_ACCESS_KEY
This would update/create the AWS Profile in your local machine
? Profile Name:  # (default)

Successfully set up the new user.
```

設定が終了すると以下に設定が追加されます。（アクセスキー等は第三者に漏れないように気をつけましょう）

```bash
cat ~/.aws/profile
cat ~/.aws/credentials
```

これで Amplify CLI の初期化は完了です。

## Next.js プロジェクトの作成

Next.js プロジェクトを作成します。

https://docs.amplify.aws/nextjs/start/getting-started/setup/

ここでは docs に習って、`--no-eslint` と `--no-tailwind` を指定しています。
プロジェクト名は `next-amplified` としています。

```bash
npm create next-app@14 -- next-amplified --ts --no-eslint --src-dir --import-alias '@/*' --no-tailwind --app
cd next-amplified
```

localhost で動作確認します。

```bash
npm run dev
```

Next.js のデフォルトのページが表示されれば OK です。

## Amplify Backend の準備

### Amplify プロジェクトの初期化

Amplify プロジェクトを初期化します。

```bash
amplify init
```

各種設定が求められるので、必要に応じて選択します。お試しであれば、基本デフォルトで良いと思います。以下はデフォルトで回答しています。

```bash
? Enter a name for the project (nextamplified)
The following configuration will be applied:

Project information
| Name: next-amplified
| Environment: dev
| Default editor: Visual Studio Code
| App type: javascript
| Javascript framework: react
| Source Directory Path: src
| Distribution Directory Path: build
| Build Command: npm run-script build
| Start Command: npm run-script start

? Initialize the project with the above configuration? Yes
Using default provider  awscloudformation
? Select the authentication method you want to use: AWS profile

For more information on AWS Profiles, see:
https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html

? Please choose the profile you want to use: default
```

※ AWS Profile を `amplify-dev` で登録している場合は、`default` ではなく `amplify-dev` を選択してください。

上記設定が終わると、以下が追加されます

- プロジェクトルートに `amplify` ディレクトリが追加される
  - amplify に関連するファイル郡
- `src` ディレクトリに `amplifyconfiguration.json` と `aws-exports.js` ファイルが追加される
  - frontend アプリケーションから amplify backend にアクセスするためのファイル
  - これら2つのファイルは自動更新されるため、直接編集しない。また .gitignore の対象なので、取り扱いに気をつける

### Amplify ライブラリの追加

次に Amplify ライブラリを追加します。 Next.js を利用するため、専用の adapter も合わせて追加します。

```bash
npm install aws-amplify @aws-amplify/adapter-nextjs
```

これは後ほど追加する Auth や API などの Amplify Backend に、React や React Server Components から接続するためのライブラリです。

以上で Amplify Backend の準備が整いました。

## Amplify Backend の追加

続いて、Amplify Backend を追加していきます。

:::message
Amplify Backend は、例えば Auth を追加すると Cognito が、API を追加すると AppSync と DynamoDB が、Storage を追加すると S3 など、それぞれの機能群に関連した AWS のサービスを cloudformation でデプロイし、 Amplify Backend として、まとめて利用・管理することができるサービスです。
:::

### API を追加

```bash
amplify add api
```

ここでは GraphQL を選択し、テンプレートは `Single object with fields (e.g., “Todo” with ID, name, description)` を選択します。

```bash
? Select from one of the below mentioned services:
> GraphQL
? Here is the GraphQL API that we will create. Select a setting to edit or continue
> Continue
? Choose a schema template:
> Single object with fields (e.g., “Todo” with ID, name, description)
...
Edit your schema at <...>/schema.graphql or place .graphql files in a directory at <...>/schema
✔ Do you want to edit the schema now? (Y/n)
> yes
Edit the file in your editor: <...>/schema.graphql
✅ Successfully added resource new locally
```

上記テンプレートを利用すると、以下のように認証なしのフルアクセスでスキーマが生成されので、取り扱いにご注意ください。

:::message
デフォルトのまま進めると、 GraphQL にアクセスする認可方法が API キーになっており、この API キーの有効期限が7日間で設定されています。有効期限を過ぎると、 `UnauthorizedException: Unknown error at buildRestApiServiceError` となり、アクセスできなくなりますので、こちらもご注意ください。

API キーが失効した場合は `amplify update api` で再設定し、 API キーを更新します。

※ ちなみに Auth を追加するときに、認証済みユーザのみでアクセスできるように変更するため、 GraphQL にアクセスするための API キーは不要になります。
:::

```graphql:amplify/backend/api/nextamplified/schema.graphql
# This "input" configures a global authorization rule to enable public access to
# all models in this schema. Learn more about authorization rules here: https://docs.amplify.aws/react/build-a-backend/graphqlapi/customize-authorization-rules/

input AMPLIFY {
  globalAuthRule: AuthRule = { allow: public }
} # FOR TESTING ONLY!
type Todo @model {
  id: ID!
  name: String!
  description: String
}
```

デフォルトだと JavaScript で GraphQL を利用することになるので、次のコマンドを実行し、 TypeScript に変更します。
typescript を選択後、すべてデフォルトを選択しました。

```bash
amplify configure codegen

? Choose the code generation language target typescript
? Enter the file name pattern of graphql queries, mutations and subscriptions src/graphql/**/*.ts
? Enter the file name for the generated code src/API.ts
? Enter maximum statement depth [increase from default if your schema is deeply nested] 2
Codegen configured. Remember to run "amplify codegen" to generate your types and statements.
```

以下で型定義やクエリなどのコードが生成されます。

```bash
amplify codegen

✔ Downloaded the schema
✔ Generated GraphQL operations successfully and saved at src/graphql
✔ Code generated successfully and saved in file src/API.ts
```

Amplify Backend に反映します。

```bash
amplify push
```

### Auth を追加

続いて Auth を追加します。デフォルトで進めています。

```bash
amplify add auth

? Do you want to use the default authentication and security configuration? Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings?  No, I am done.
```

:::message
Auth については、 GET系の [fetchAuthSession, fetchUserAttributes, getCurrentUser](https://docs.amplify.aws/nextjs/build-a-backend/server-side-rendering/#supported-apis-for-nextjs-server-side-usage) のみ  React Server Components で利用できるため、 GET 以外の HTTP リクエストメソッドは Client Component から実行する必要があります。
:::

続いて、 Amplify UI コンポーネントを利用するため、以下のライブラリを追加します。

```bash
npm install @aws-amplify/ui-react
```

2023/12/10現在、新規登録やログインについては Client Component でのライブラリ利用が必要です。
以下の画像は Amplify UI で提供している Authenticator コンポーネントで、後ほど hooks で利用します。

![Amplify UI の Sign In と Create Account の画像](/images/articles/a9834076fcc101/sign-in-and-create-account.png)

### API を Auth で保護する

ここまでの設定だと schema が `allow: public` になっていることに加え、 API の認可が API key になっているので、どのユーザが登録しても、すべてのユーザで登録したデータがCRUDできてしまいます。
これを Amazon Cognito User Pool を利用して、ログインユーザごとで認可を分けるように変更します。

まずは schema に @auth ディレクティブを追加します。
※ 詳細は [docs の `Customize authorization rules`](https://docs.amplify.aws/nextjs/build-a-backend/graphqlapi/customize-authorization-rules/) を参照してください。

```graphql:amplify/backend/api/nextamplified/schema.graphql
type Todo @model @auth(rules: [{ allow: owner }]) {
  id: ID!
  name: String!
  description: String
}
```

次に型やクエリなどのコードを再生成します。

```bash
amplify codegen
```

続いて `amplify update api` で API key から Amazon Cognito User Pool に変更します。

```bash
amplify update api

? Select from one of the below mentioned services: GraphQL
? Select a setting to edit Authorization modes
? Choose the default authorization type for the API (Use arrow keys)
  API key
❯ Amazon Cognito User Pool
  IAM
  OpenID Connect
  Lambda
? Configure additional auth types? No
```

最後に Amplify Backend に反映します。

```bash
amplify push
```

これで API key ではなく、 Amazon Cognito User Pool で認可されたユーザのみが CRUD できるようになりました。

## アプリケーション実装

前回までで、Amplify Backend (Auth, API) の設定ができました。
ここからは、実際にアプリケーションを実装していきます。

### ディレクトリ構成

最終的なディレクトリ構成は以下のとおりです。

<<< 編集注: 以下のディレクトリ構成は WIP なので最終的に改めて調整する >>>

```bash
.
├── README.md
├── amplify
│   ├── ...
│   ...
│
├── next-env.d.ts
├── next.config.js
├── package-lock.json
├── package.json
├── public
│   ├── next.svg
│   └── vercel.svg
├── src
│   ├── API.ts
│   ├── amplifyconfiguration.json
│   ├── app
│   │   ├── favicon.ico
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   └── todos
│   │       └── page.tsx
│   ├── aws-exports.js
│   ├── components
│   │   ├── AuthGetCurrentUserServer.tsx
│   │   ├── AuthProvider.tsx
│   │   ├── AuthenticatorClient.tsx
│   │   ├── ConfigureAmplifyClientSide.ts
│   │   ├── SignOutButton.tsx
│   │   ├── Todo.tsx
│   │   ├── TodoNew.tsx
│   │   ├── TodosServer.tsx
│   │   └── useAuthRedirect.ts
│   ├── graphql
│   │   ├── mutations.ts
│   │   ├── queries.ts
│   │   ├── schema.json
│   │   └── subscriptions.ts
│   ├── middleware.ts
│   └── utils
│       └── amplifyServerUtils.ts
└── tsconfig.json
```

### Amplify ライブラリの読み込み

今回は Next.js を App Router で利用します。
React Server Components (RSC) でも、 Client Component (便宜上、 RCC と表現します) でも、 Amplify ライブラリを利用するため、以下のように Amplify ライブラリを読み込みます。

まずは RCC 側です。

```ts:src/components/ConfigureAmplifyClientSide.ts
'use client';

import { Amplify } from 'aws-amplify';
import config from '@/amplifyconfiguration.json';

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
  return null;
}
```

`Amplify.configure` は一度だけ呼び出したいので、ルートレイアウトに設置します。

```tsx:src/app/layout.tsx
import ConfigureAmplifyClientSide from '@/components/ConfigureAmplifyClientSide';
import './globals.css';

import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <>
          <ConfigureAmplifyClientSide />
          {children}
        </>
      </body>
    </html>
  );
}
```

続いて RSC 側です。

```ts:src/utils/amplifyServerUtils.ts
import { createServerRunner } from '@aws-amplify/adapter-nextjs';
import { fetchAuthSession } from 'aws-amplify/auth/server';
import { generateServerClientUsingCookies } from '@aws-amplify/adapter-nextjs/api';
import config from '~/amplifyconfiguration.json';
import { cookies } from 'next/headers';

export const { runWithAmplifyServerContext } = createServerRunner({
  config,
});

type NextServerContext = Parameters<
  typeof runWithAmplifyServerContext
>[0]['nextServerContext'];

export const getAuthenticated = async (
  nextServerContext: NextServerContext
) => {
  return await runWithAmplifyServerContext({
    nextServerContext,
    operation: async (contextSpec) => {
      try {
        const session = await fetchAuthSession(contextSpec);
        return session.tokens !== undefined;
      } catch (error) {
        console.log(error);
        return false;
      }
    },
  });
};

export const cookieBasedClient = generateServerClientUsingCookies({
  config,
  cookies,
});
```

```tsx:src/components/AuthGetCurrentUserServer.tsx
import { cookies } from 'next/headers';
import { getCurrentUser } from '@aws-amplify/auth/server';
import { runWithAmplifyServerContext } from '@/utils/amplifyServerUtils';

// NOTE: 公式ドキュメントで定義されていないコンポーネントだったので、仮に追加
const AuthFetchResult = ({ description, data }) => {
  return (
    <div>
      <p>{description}</p>
      <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
  );
};

// This page always dynamically renders per request
export const dynamic = 'force-dynamic';

export default async function AuthGetCurrentUserServer() {
  try {
    const currentUser = await runWithAmplifyServerContext({
      nextServerContext: { cookies },
      operation: (contextSpec) => getCurrentUser(contextSpec),
    });

    return (
      <AuthFetchResult
        description="The API is called on the server side."
        data={currentUser}
      />
    );
  } catch (error) {
    console.error(error);
    return <p>Something went wrong...</p>;
  }
}
```

また server-side runtimes として、 middleware でも利用でき、認証によるアクセス制御も可能です。 ※ [middleware は 2023/12/10現在 Auth のみで利用できるようです。](https://docs.amplify.aws/nextjs/build-a-backend/server-side-rendering/#supported-apis-for-nextjs-server-side-usage)

```ts:src/middleware.ts
import { NextRequest, NextResponse } from 'next/server';
import { getAuthenticated } from '@/utils/amplifyServerUtils';

export async function middleware(request: NextRequest) {
  const url = new URL(request.url);
  const response = NextResponse.next();

  if (url.pathname === '/') {
    return response;
  }

  const authenticated = await getAuthenticated({
    request,
    response,
  });

  if (authenticated) {
    return response;
  }

  return NextResponse.redirect(new URL('/', request.url));
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|todos).*)',
  ],
};
```
