---
title: "AWS Amplify ã§ Next.js App Router ã‚’åˆ©ç”¨ã™ã‚‹"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws,amplify,nextjs,approuter,typescript]
published: false
---

## ã¯ã˜ã‚ã«

https://aws.amazon.com/jp/blogs/news/amplify-javascript-v6/

ä¸Šè¨˜ãƒ–ãƒ­ã‚°ã§ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€ Amplify ã§ Next.js App Router ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ Amplify ã§ Next.js App Router ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã«åŠ ãˆã€Amplify Backend ã§ Auth (Cognite) ã¨ API (GraphQL + DynamoDB) ã‚’è¿½åŠ ã—ã€ç°¡æ˜“çš„ãª CRUD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

## å¯¾è±¡èª­è€…

- AWS Amplify ã§ Next.js App Router ã‚’åˆ©ç”¨ã—ãŸã„æ–¹
- AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹
- AWS ã®åŸºæœ¬çš„ãªçŸ¥è­˜ã‚’ãŠæŒã¡ã®æ–¹
- Next.js ã®åŸºæœ¬çš„ãªçŸ¥è­˜ã‚’ãŠæŒã¡ã®æ–¹
- TypeScript ã®åŸºæœ¬çš„ãªçŸ¥è­˜ã‚’ãŠæŒã¡ã®æ–¹

## äº‹å‰æº–å‚™

https://docs.amplify.aws/nextjs/start/getting-started/installation/

ä¸Šè¨˜ã® docs ã«æ²¿ã£ã¦ã€äº‹å‰æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚
â€» Node.js ã¨ Git ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ã€‚

### AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ

AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒã£ã¦ã„ãªã„æ–¹ã¯ã€ä¸Šè¨˜ã® docs ã‹ã‚‰ã€ŒCreate AWS Accountã€ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
â€» admin æ¨©é™ã‚’æŒã£ãŸ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€ãã® IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

### Amplify CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Amplify CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm install -g @aws-amplify/cli
```

### Amplify CLI ã®åˆæœŸåŒ–

Amplify CLI ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

```bash
amplify configure
```

ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã™ã®ã§ã€AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ã€ŒContinueã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

```bash
â¯ amplify configure
Follow these steps to set up access to your AWS account:

Sign in to your AWS administrator account:
https://console.aws.amazon.com/
Press Enter to continue
```

æ¬¡ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ region ã‚’é¸æŠã—ã¾ã™ã€‚
â€» ä»Šå›ã¯ ap-northeast-1 ã‚’é¸æŠã—ã¾ã™ã€‚

```bash
Specify the AWS Region
? region:  ap-northeast-1
```

æ¬¡ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ Amplify ç”¨ã® IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
è©³ç´°ã¯ [docs ã® `Enter a User name and select Next. You can name the user anything but we'll call it "amplify-dev".`](https://docs.amplify.aws/javascript/start/getting-started/installation/#configure-the-amplify-cli) ã‹ã‚‰å§‹ã¾ã‚‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

docs ã§ã¯ãƒ¦ãƒ¼ã‚¶ã‚’ `amplify-dev` ã§ã€ãƒãƒªã‚·ãƒ¼ã‚’ `AdministratorAccess-Amplify` ã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ãŸã‚‰ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ã€‚
amplify-dev ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼æƒ…å ±ã€ã®ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã€Œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

docs ã«æ²¿ã£ã¦é€²ã‚ã¦ã„ãã¨ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã‚Šã€Enterã‚’æŠ¼ã™ã¨ã€`Access key` ã¨ `Secret access key` ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€ã‚³ãƒ”ãƒšã—ã¦å…¥åŠ›ã—ã¾ã™ã€‚

â€» AWS Profile ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€åˆ©ç”¨ã—ã¦ã„ã‚‹ç«¯æœ«ã§åˆã‚ã¦è¨­å®šã™ã‚‹ã®ã§ã‚ã‚Œã° `default` ã€ã‚‚ã—ã™ã§ã« `default` ãŒè¨­å®šã—ã¦ã‚ã‚‹å ´åˆã¯ `amplify-dev` ãªã©ã€ã‚ã‹ã‚Šã‚„ã™ã„åç§°ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```bash
Enter the access key of the newly created user:
? accessKeyId:  # YOUR_ACCESS_KEY_ID
? secretAccessKey:  # YOUR_SECRET_ACCESS_KEY
This would update/create the AWS Profile in your local machine
? Profile Name:  # (default)

Successfully set up the new user.
```

è¨­å®šãŒçµ‚äº†ã™ã‚‹ã¨ä»¥ä¸‹ã«è¨­å®šãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ç­‰ã¯ç¬¬ä¸‰è€…ã«æ¼ã‚Œãªã„ã‚ˆã†ã«æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ï¼‰

```bash
cat ~/.aws/profile
cat ~/.aws/credentials
```

ã“ã‚Œã§ Amplify CLI ã®åˆæœŸåŒ–ã¯å®Œäº†ã§ã™ã€‚

## Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

https://docs.amplify.aws/nextjs/start/getting-started/setup/

ã“ã“ã§ã¯ docs ã«ç¿’ã£ã¦ã€`--no-eslint` ã¨ `--no-tailwind` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ `next-amplified` ã¨ã—ã¦ã„ã¾ã™ã€‚

```bash
npm create next-app@14 -- next-amplified --ts --no-eslint --src-dir --import-alias '@/*' --no-tailwind --app
cd next-amplified
```

localhost ã§å‹•ä½œç¢ºèªã—ã¾ã™ã€‚

```bash
npm run dev
```

Next.js ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° OK ã§ã™ã€‚

## Amplify Backend ã®æº–å‚™

### Amplify ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–

Amplify ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚

```bash
amplify init
```

å„ç¨®è¨­å®šãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦é¸æŠã—ã¾ã™ã€‚ãŠè©¦ã—ã§ã‚ã‚Œã°ã€åŸºæœ¬ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å›ç­”ã—ã¦ã„ã¾ã™ã€‚

```bash
? Enter a name for the project (nextamplified)
The following configuration will be applied:

Project information
| Name: next-amplified
| Environment: dev
| Default editor: Visual Studio Code
| App type: javascript
| Javascript framework: react
| Source Directory Path: src
| Distribution Directory Path: build
| Build Command: npm run-script build
| Start Command: npm run-script start

? Initialize the project with the above configuration? Yes
Using default provider  awscloudformation
? Select the authentication method you want to use: AWS profile

For more information on AWS Profiles, see:
https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html

? Please choose the profile you want to use: default
```

â€» AWS Profile ã‚’ `amplify-dev` ã§ç™»éŒ²ã—ã¦ã„ã‚‹å ´åˆã¯ã€`default` ã§ã¯ãªã `amplify-dev` ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

ä¸Šè¨˜è¨­å®šãŒçµ‚ã‚ã‚‹ã¨ã€ä»¥ä¸‹ãŒè¿½åŠ ã•ã‚Œã¾ã™

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `amplify` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¿½åŠ ã•ã‚Œã‚‹
  - amplify ã«é–¢é€£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«éƒ¡
- `src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `amplifyconfiguration.json` ã¨ `aws-exports.js` ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹
  - frontend ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ amplify backend ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«
  - ã“ã‚Œã‚‰2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ç›´æ¥ç·¨é›†ã—ãªã„ã€‚ã¾ãŸ .gitignore ã®å¯¾è±¡ãªã®ã§ã€å–ã‚Šæ‰±ã„ã«æ°—ã‚’ã¤ã‘ã‚‹

### Amplify ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ 

æ¬¡ã« Amplify ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚ Next.js ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€å°‚ç”¨ã® adapter ã‚‚åˆã‚ã›ã¦è¿½åŠ ã—ã¾ã™ã€‚

```bash
npm install aws-amplify @aws-amplify/adapter-nextjs
```

ã“ã‚Œã¯å¾Œã»ã©è¿½åŠ ã™ã‚‹ Auth ã‚„ API ãªã©ã® Amplify Backend ã«ã€React ã‚„ React Server Components ã‹ã‚‰æ¥ç¶šã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

ä»¥ä¸Šã§ Amplify Backend ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

## Amplify Backend ã®è¿½åŠ 

ç¶šã„ã¦ã€Amplify Backend ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

:::message
Amplify Backend ã¯ã€ä¾‹ãˆã° Auth ã‚’è¿½åŠ ã™ã‚‹ã¨ Cognito ãŒã€API ã‚’è¿½åŠ ã™ã‚‹ã¨ AppSync ã¨ DynamoDB ãŒã€Storage ã‚’è¿½åŠ ã™ã‚‹ã¨ S3 ãªã©ã€ãã‚Œãã‚Œã®æ©Ÿèƒ½ç¾¤ã«é–¢é€£ã—ãŸ AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ cloudformation ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ Amplify Backend ã¨ã—ã¦ã€ã¾ã¨ã‚ã¦åˆ©ç”¨ãƒ»ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
:::

### API ã‚’è¿½åŠ 

```bash
amplify add api
```

ã“ã“ã§ã¯ GraphQL ã‚’é¸æŠã—ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ `Single object with fields (e.g., â€œTodoâ€ with ID, name, description)` ã‚’é¸æŠã—ã¾ã™ã€‚

```bash
? Select from one of the below mentioned services:
> GraphQL
? Here is the GraphQL API that we will create. Select a setting to edit or continue
> Continue
? Choose a schema template:
> Single object with fields (e.g., â€œTodoâ€ with ID, name, description)
...
Edit your schema at <...>/schema.graphql or place .graphql files in a directory at <...>/schema
âœ” Do you want to edit the schema now? (Y/n)
> yes
Edit the file in your editor: <...>/schema.graphql
âœ… Successfully added resource new locally
```

ä¸Šè¨˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«èªè¨¼ãªã—ã®ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚¹ã‚­ãƒ¼ãƒãŒç”Ÿæˆã•ã‚Œã®ã§ã€å–ã‚Šæ‰±ã„ã«ã”æ³¨æ„ãã ã•ã„ã€‚

:::message
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾é€²ã‚ã‚‹ã¨ã€ GraphQL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹èªå¯æ–¹æ³•ãŒ API ã‚­ãƒ¼ã«ãªã£ã¦ãŠã‚Šã€ã“ã® API ã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒ7æ—¥é–“ã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚æœ‰åŠ¹æœŸé™ã‚’éãã‚‹ã¨ã€ `UnauthorizedException: Unknown error at buildRestApiServiceError` ã¨ãªã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã®ã§ã€ã“ã¡ã‚‰ã‚‚ã”æ³¨æ„ãã ã•ã„ã€‚

API ã‚­ãƒ¼ãŒå¤±åŠ¹ã—ãŸå ´åˆã¯ `amplify update api` ã§å†è¨­å®šã—ã€ API ã‚­ãƒ¼ã‚’æ›´æ–°ã—ã¾ã™ã€‚

â€» ã¡ãªã¿ã« Auth ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ã®ã¿ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ãŸã‚ã€ GraphQL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã® API ã‚­ãƒ¼ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚
:::

```graphql:amplify/backend/api/nextamplified/schema.graphql
# This "input" configures a global authorization rule to enable public access to
# all models in this schema. Learn more about authorization rules here: https://docs.amplify.aws/react/build-a-backend/graphqlapi/customize-authorization-rules/

input AMPLIFY {
  globalAuthRule: AuthRule = { allow: public }
} # FOR TESTING ONLY!
type Todo @model {
  id: ID!
  name: String!
  description: String
}
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ JavaScript ã§ GraphQL ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ TypeScript ã«å¤‰æ›´ã—ã¾ã™ã€‚
typescript ã‚’é¸æŠå¾Œã€ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é¸æŠã—ã¾ã—ãŸã€‚

```bash
amplify configure codegen

? Choose the code generation language target typescript
? Enter the file name pattern of graphql queries, mutations and subscriptions src/graphql/**/*.ts
? Enter the file name for the generated code src/API.ts
? Enter maximum statement depth [increase from default if your schema is deeply nested] 2
Codegen configured. Remember to run "amplify codegen" to generate your types and statements.
```

ä»¥ä¸‹ã§å‹å®šç¾©ã‚„ã‚¯ã‚¨ãƒªãªã©ã®ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```bash
amplify codegen

âœ” Downloaded the schema
âœ” Generated GraphQL operations successfully and saved at src/graphql
âœ” Code generated successfully and saved in file src/API.ts
```

Amplify Backend ã«åæ˜ ã—ã¾ã™ã€‚

```bash
amplify push
```

### Auth ã‚’è¿½åŠ 

ç¶šã„ã¦ Auth ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€²ã‚ã¦ã„ã¾ã™ã€‚

```bash
amplify add auth

? Do you want to use the default authentication and security configuration? Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings?  No, I am done.
```

:::message
Auth ã«ã¤ã„ã¦ã¯ã€ GETç³»ã® [fetchAuthSession, fetchUserAttributes, getCurrentUser](https://docs.amplify.aws/nextjs/build-a-backend/server-side-rendering/#supported-apis-for-nextjs-server-side-usage) ã®ã¿  React Server Components ã§åˆ©ç”¨ã§ãã‚‹ãŸã‚ã€ GET ä»¥å¤–ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã¯ Client Component ã‹ã‚‰å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

ç¶šã„ã¦ã€ Amplify UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

```bash
npm install @aws-amplify/ui-react
```

2023/12/10ç¾åœ¨ã€æ–°è¦ç™»éŒ²ã‚„ãƒ­ã‚°ã‚¤ãƒ³ã«ã¤ã„ã¦ã¯ Client Component ã§ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ©ç”¨ãŒå¿…è¦ã§ã™ã€‚
ä»¥ä¸‹ã®ç”»åƒã¯ Amplify UI ã§æä¾›ã—ã¦ã„ã‚‹ Authenticator ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã€å¾Œã»ã© hooks ã§åˆ©ç”¨ã—ã¾ã™ã€‚

![Amplify UI ã® Sign In ã¨ Create Account ã®ç”»åƒ](/images/articles/a9834076fcc101/sign-in-and-create-account.png)

### API ã‚’ Auth ã§ä¿è­·ã™ã‚‹

ã“ã“ã¾ã§ã®è¨­å®šã ã¨ schema ãŒ `allow: public` ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã«åŠ ãˆã€ API ã®èªå¯ãŒ API key ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã©ã®ãƒ¦ãƒ¼ã‚¶ãŒç™»éŒ²ã—ã¦ã‚‚ã€ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ã§ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒCRUDã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã‚Œã‚’ Amazon Cognito User Pool ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã”ã¨ã§èªå¯ã‚’åˆ†ã‘ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ã¾ãšã¯ schema ã« @auth ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¿½åŠ ã—ã¾ã™ã€‚
â€» è©³ç´°ã¯ [docs ã® `Customize authorization rules`](https://docs.amplify.aws/nextjs/build-a-backend/graphqlapi/customize-authorization-rules/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```graphql:amplify/backend/api/nextamplified/schema.graphql
type Todo @model @auth(rules: [{ allow: owner }]) {
  id: ID!
  name: String!
  description: String
}
```

æ¬¡ã«å‹ã‚„ã‚¯ã‚¨ãƒªãªã©ã®ã‚³ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆã—ã¾ã™ã€‚

```bash
amplify codegen
```

ç¶šã„ã¦ `amplify update api` ã§ API key ã‹ã‚‰ Amazon Cognito User Pool ã«å¤‰æ›´ã—ã¾ã™ã€‚

```bash
amplify update api

? Select from one of the below mentioned services: GraphQL
? Select a setting to edit Authorization modes
? Choose the default authorization type for the API (Use arrow keys)
  API key
â¯ Amazon Cognito User Pool
  IAM
  OpenID Connect
  Lambda
? Configure additional auth types? No
```

æœ€å¾Œã« Amplify Backend ã«åæ˜ ã—ã¾ã™ã€‚

```bash
amplify push
```

ã“ã‚Œã§ API key ã§ã¯ãªãã€ Amazon Cognito User Pool ã§èªå¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ã®ã¿ãŒ CRUD ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

å‰å›ã¾ã§ã§ã€Amplify Backend (Auth, API) ã®è¨­å®šãŒã§ãã¾ã—ãŸã€‚
ã“ã“ã‹ã‚‰ã¯ã€å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

<<< ç·¨é›†æ³¨: ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ WIP ãªã®ã§æœ€çµ‚çš„ã«æ”¹ã‚ã¦èª¿æ•´ã™ã‚‹ >>>

```bash
.
â”œâ”€â”€ README.md
â”œâ”€â”€ amplify
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  ...
â”‚
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ next.config.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ next.svg
â”‚Â Â  â””â”€â”€ vercel.svg
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ API.ts
â”‚Â Â  â”œâ”€â”€ amplifyconfiguration.json
â”‚Â Â  â”œâ”€â”€ app
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ favicon.ico
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ layout.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ page.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ todos
â”‚Â Â  â”‚Â Â      â””â”€â”€ page.tsx
â”‚Â Â  â”œâ”€â”€ aws-exports.js
â”‚Â Â  â”œâ”€â”€ components
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AuthGetCurrentUserServer.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AuthProvider.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AuthenticatorClient.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ConfigureAmplifyClientSide.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ SignOutButton.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Todo.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TodoNew.tsx
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TodosServer.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ useAuthRedirect.ts
â”‚Â Â  â”œâ”€â”€ graphql
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mutations.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ queries.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ schema.json
â”‚Â Â  â”‚Â Â  â””â”€â”€ subscriptions.ts
â”‚Â Â  â”œâ”€â”€ middleware.ts
â”‚Â Â  â””â”€â”€ utils
â”‚Â Â      â””â”€â”€ amplifyServerUtils.ts
â””â”€â”€ tsconfig.json
```

### Amplify ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿

ä»Šå›ã¯ Next.js ã‚’ App Router ã§åˆ©ç”¨ã—ã¾ã™ã€‚
React Server Components (RSC) ã§ã‚‚ã€ Client Component (ä¾¿å®œä¸Šã€ RCC ã¨è¡¨ç¾ã—ã¾ã™) ã§ã‚‚ã€ Amplify ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Amplify ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

ã¾ãšã¯ RCC å´ã§ã™ã€‚

```ts:src/components/ConfigureAmplifyClientSide.ts
'use client';

import { Amplify } from 'aws-amplify';
import config from '@/amplifyconfiguration.json';

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
  return null;
}
```

`Amplify.configure` ã¯ä¸€åº¦ã ã‘å‘¼ã³å‡ºã—ãŸã„ã®ã§ã€ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«è¨­ç½®ã—ã¾ã™ã€‚

```tsx:src/app/layout.tsx
import ConfigureAmplifyClientSide from '@/components/ConfigureAmplifyClientSide';
import './globals.css';

import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <>
          <ConfigureAmplifyClientSide />
          {children}
        </>
      </body>
    </html>
  );
}
```

ç¶šã„ã¦ RSC å´ã§ã™ã€‚

```ts:src/utils/amplifyServerUtils.ts
import { createServerRunner } from '@aws-amplify/adapter-nextjs';
import { fetchAuthSession } from 'aws-amplify/auth/server';
import { generateServerClientUsingCookies } from '@aws-amplify/adapter-nextjs/api';
import config from '~/amplifyconfiguration.json';
import { cookies } from 'next/headers';

export const { runWithAmplifyServerContext } = createServerRunner({
  config,
});

type NextServerContext = Parameters<
  typeof runWithAmplifyServerContext
>[0]['nextServerContext'];

export const getAuthenticated = async (
  nextServerContext: NextServerContext
) => {
  return await runWithAmplifyServerContext({
    nextServerContext,
    operation: async (contextSpec) => {
      try {
        const session = await fetchAuthSession(contextSpec);
        return session.tokens !== undefined;
      } catch (error) {
        console.log(error);
        return false;
      }
    },
  });
};

export const cookieBasedClient = generateServerClientUsingCookies({
  config,
  cookies,
});
```

```tsx:src/components/AuthGetCurrentUserServer.tsx
import { cookies } from 'next/headers';
import { getCurrentUser } from '@aws-amplify/auth/server';
import { runWithAmplifyServerContext } from '@/utils/amplifyServerUtils';

// NOTE: å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã£ãŸã®ã§ã€ä»®ã«è¿½åŠ 
const AuthFetchResult = ({ description, data }) => {
  return (
    <div>
      <p>{description}</p>
      <pre>{JSON.stringify(data, null, 2)}</pre>
    </div>
  );
};

// This page always dynamically renders per request
export const dynamic = 'force-dynamic';

export default async function AuthGetCurrentUserServer() {
  try {
    const currentUser = await runWithAmplifyServerContext({
      nextServerContext: { cookies },
      operation: (contextSpec) => getCurrentUser(contextSpec),
    });

    return (
      <AuthFetchResult
        description="The API is called on the server side."
        data={currentUser}
      />
    );
  } catch (error) {
    console.error(error);
    return <p>Something went wrong...</p>;
  }
}
```

ã¾ãŸ server-side runtimes ã¨ã—ã¦ã€ middleware ã§ã‚‚åˆ©ç”¨ã§ãã€èªè¨¼ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚‚å¯èƒ½ã§ã™ã€‚ â€» [middleware ã¯ 2023/12/10ç¾åœ¨ Auth ã®ã¿ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚](https://docs.amplify.aws/nextjs/build-a-backend/server-side-rendering/#supported-apis-for-nextjs-server-side-usage)

```ts:src/middleware.ts
import { NextRequest, NextResponse } from 'next/server';
import { getAuthenticated } from '@/utils/amplifyServerUtils';

export async function middleware(request: NextRequest) {
  const url = new URL(request.url);
  const response = NextResponse.next();

  if (url.pathname === '/') {
    return response;
  }

  const authenticated = await getAuthenticated({
    request,
    response,
  });

  if (authenticated) {
    return response;
  }

  return NextResponse.redirect(new URL('/', request.url));
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|todos).*)',
  ],
};
```
